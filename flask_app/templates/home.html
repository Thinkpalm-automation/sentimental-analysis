{% extends 'base.html' %}
{% block title %}Home | Team Sentiment Analysis{% endblock %}
{% block head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body { background-color: #f7f9fc; }
    .kpi-card { min-width: 180px; }
    .card-positive { background: #4CAF50; color: #fff; }
    .card-neutral { background: #BDBDBD; color: #fff; }
    .card-negative { background: #F44336; color: #fff; }
    .card-accent { background: #1976D2; color: #fff; }
    .card-navbar-blue { background-color: #003366 !important; color: #fff !important; }
    .flag-row { background: #fff3cd !important; }
    .footer { margin-top: 2rem; padding: 1rem 0; text-align: center; color: #888; }
</style>
{% endblock %}
{% block content %}
<div class="my-4">
    <h4 class="text-success">Upload your JIRA export to get started</h4>
    <div class="alert alert-info" role="alert">
        <strong>Instructions:</strong> Please upload your <b>JIRA CSV or Excel file</b>.<br>
        For Gerrit analysis, also upload your <b>Consolidated Gerrit Comments JSON</b> at the same time.<br>
        <span class="text-danger">Gerrit analysis will only be available if both files are uploaded together.</span>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <form method="post" enctype="multipart/form-data" id="upload-form">
        <label for="jira_file" class="form-label">JIRA CSV or Excel file</label>
        <input type="file" name="jira_file" class="form-control mb-2" required>
        <label for="gerrit_file" class="form-label">Consolidated Gerrit Comments (JSON, optional)</label>
        <input type="file" name="gerrit_file" class="form-control mb-2">
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>
</div>
{% if kpis.total_comments > 0 %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="alert alert-secondary text-center">
            <strong>Total Entries in CSV:</strong> {{ kpis.total_comments }}
        </div>
    </div>
</div>
{% endif %}
<div class="mb-4">
    <h1 class="fw-bold text-accent mb-3">Team Sentiment Analysis</h1>
    {% if not selected_team %}
    <div class="alert alert-warning text-center mt-3">
        Please select a team from the top right to view the sentiment data.
    </div>
    {% endif %}
    <div class="row mb-2 justify-content-center">
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <div class="card text-center h-100">
                <div class="card-body p-2 bg-primary text-white">
                    <h6 class="card-title mb-1">Bugs</h6>
                    <div class="display-6">{{ total_bugs }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <div class="card text-center h-100">
                <div class="card-body p-2 bg-primary text-white">
                    <h6 class="card-title mb-1">Non-Bugs</h6>
                    <div class="display-6">{{ total_nonbugs }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card text-center h-100">
                <div class="card-body p-2 bg-primary text-white">
                    <h6 class="card-title mb-1">Gerrit</h6>
                    <div class="display-6">{{ total_gerrit }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-12 col-md-6 mb-2 mb-md-0">
            <div class="card text-center card-positive h-100">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">Positive %</h6>
                    <div class="display-6">{{ kpis.positive_pct }}%</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card text-center card-negative h-100">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">Negative %</h6>
                    <div class="display-6">{{ kpis.negative_pct }}%</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4 g-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Team Sentiment Distribution</div>
            <div class="card-body d-flex justify-content-center align-items-center" style="min-height:220px;">
                <canvas id="sentimentPie" style="max-width:300px;max-height:220px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Team Negative Sentiment Breakdown</div>
            <div class="card-body">
                <canvas id="assigneeBar"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    <button class="btn btn-outline-primary me-2" id="download-csv">Download CSV</button>
    <button class="btn btn-outline-success me-2" id="download-xlsx">Download Excel</button>
    <span class="ms-3">Last updated: {{ last_updated }}</span>
    <span class="ms-3">&copy; ThinkPalm / Sentiment Analysis Dashboard</span>
</div>
{% endblock %}
{% block scripts %}
<script>
// Store all team sentiment data
const teamSentiment = {{ team_sentiment_dict | tojson }};
const selectedTeam = "{{ selected_team }}";
const overallPie = {{ chart_data.pie | tojson }};
const overallBarLabels = {{ chart_data.bar_labels | tojson }};
const overallBarValues = {{ chart_data.bar_values | tojson }};

// Chart.js Pie
const pieCtx = document.getElementById('sentimentPie').getContext('2d');
let sentimentPie = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: ['Positive', 'Neutral', 'Negative'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#4CAF50', '#BDBDBD', '#F44336']
        }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
// Chart.js Bar
const barCtx = document.getElementById('assigneeBar').getContext('2d');
let assigneeBar = new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'Negative Comments',
            data: [],
            backgroundColor: '#F44336'
        }]
    },
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
});

// Hide charts initially
$(document).ready(function() {
    // Show charts for selected team on load
    if (selectedTeam && teamSentiment[selectedTeam]) {
        $('.row.mb-4.g-3').show();
        const teamData = teamSentiment[selectedTeam] || {};
        let pie = [0, 0, 0];
        let barLabels = [];
        let barValues = [];
        if (Object.keys(teamData).length > 0) {
            for (const member in teamData) {
                const memberData = teamData[member];
                pie[0] += memberData["Positive"];
                pie[1] += memberData["Neutral"];
                pie[2] += memberData["Negative"];
                barLabels.push(member);
                barValues.push(memberData["Negative"]);
            }
        }
        sentimentPie.data.datasets[0].data = pie;
        assigneeBar.data.labels = barLabels;
        assigneeBar.data.datasets[0].data = barValues;
        sentimentPie.update();
        assigneeBar.update();
    } else {
        $('.row.mb-4.g-3').hide();
    }
});

// DataTables
$(document).ready(function() {
    var table = $('#ticketTable').DataTable();
    $('#searchBox').on('keyup', function() {
        table.search(this.value).draw();
    });
});
// Download buttons (CSV/XLSX)
document.getElementById('download-csv').onclick = function() { window.location = '/download/csv'; };
document.getElementById('download-xlsx').onclick = function() { window.location = '/download/xlsx'; };
</script>
{% endblock %} 
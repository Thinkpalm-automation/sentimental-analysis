{% extends 'base.html' %}
{% block title %}Home | Team Sentiment Analysis{% endblock %}
{% block head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CDN -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
    body { background-color: #f7f9fc; }
    .kpi-card { min-width: 180px; }
    .card-positive { background: #4CAF50; color: #fff; }
    .card-neutral { background: #BDBDBD; color: #fff; }
    .card-negative { background: #F44336; color: #fff; }
    .card-accent { background: #1976D2; color: #fff; }
    .card-navbar-blue { background-color: #003366 !important; color: #fff !important; }
    .flag-row { background: #fff3cd !important; }
    .footer { margin-top: 2rem; padding: 1rem 0; text-align: center; color: #888; }
    .mode-section { margin-bottom: 2rem; }
    .auto-options { display: none; }
    .manual-options { display: none; }
    .progress-section { display: none; }
    .error-dialog { display: none; }
</style>
{% endblock %}
{% block content %}
<div class="my-4">
    <h4 class="text-success">Select Data Source Mode</h4>
    
    <!-- Data Status Indicator -->
    <div class="data-status mb-3" id="dataStatus">
        {% if session.get('jira_file') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> 
                <strong>Data Loaded:</strong> 
                Jira file: {{ session.get('jira_file') }}
                {% if session.get('gerrit_file') %}
                    | Gerrit file: {{ session.get('gerrit_file') }}
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle"></i> 
                <strong>No Data Loaded:</strong> Please upload files or fetch data from Jira to begin analysis.
            </div>
        {% endif %}
    </div>
    
    <!-- Mode Selection -->
    <div class="mode-section">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="dataMode" id="manualMode" value="manual" checked>
            <label class="form-check-label" for="manualMode">
                <strong>Manual Mode</strong> - Upload files manually
            </label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="dataMode" id="autoMode" value="auto">
            <label class="form-check-label" for="autoMode">
                <strong>Auto Mode</strong> - Fetch data from Jira automatically
            </label>
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-outline-danger btn-sm" id="clearDataBtn" {% if not session.get('jira_file') %}style="display: none;"{% endif %}>
                <i class="fas fa-trash"></i> Clear Existing Data
            </button>
        </div>
    </div>

    <!-- Manual Mode Options -->
    <div class="manual-options" id="manualOptions">
        <div class="alert alert-info" role="alert">
            <strong>Instructions:</strong> Please upload your <b>JIRA CSV or Excel file</b>.<br>
            For Gerrit analysis, also upload your <b>Consolidated Gerrit Comments JSON</b> at the same time.<br>
            <span class="text-danger">Gerrit analysis will only be available if both files are uploaded together.</span>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <form method="post" enctype="multipart/form-data" id="upload-form">
            <input type="hidden" name="mode" value="manual">
            <label for="jira_file" class="form-label">JIRA CSV or Excel file</label>
            <input type="file" name="jira_file" class="form-control mb-2" required>
            <label for="gerrit_file" class="form-label">Consolidated Gerrit Comments (JSON, optional)</label>
            <input type="file" name="gerrit_file" class="form-control mb-2">
            <button type="submit" class="btn" style="background:#1565c0; color:#fff;">Upload</button>
        </form>
    </div>

    <!-- Auto Mode Options -->
    <div class="auto-options" id="autoOptions">
        <div class="alert alert-info" role="alert">
            <strong>Auto Mode:</strong> Data will be fetched automatically from Jira and processed.<br>
            <span class="text-info">This will fetch team details, generate JQL queries, download CSV, and process Gerrit comments automatically.</span>
        </div>
        <form method="post" id="auto-form">
            <input type="hidden" name="mode" value="auto">
            <div class="row">
                <div class="col-md-6">
                    <label for="jira_url" class="form-label">Jira Server URL</label>
                    <input type="text" name="jira_url" id="jira_url" class="form-control mb-2" value="https://jira.cohesity.com/" readonly>
                </div>
                <div class="col-md-6">
                    <label for="jira_username" class="form-label">Jira Username/Email</label>
                    <input type="text" name="jira_username" id="jira_username" class="form-control mb-2" value="" placeholder="Enter your Jira username or email">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="jira_token" class="form-label">Jira API Token (PAT)</label>
                    <input type="password" name="jira_token" id="jira_token" class="form-control mb-2" value="" placeholder="Enter your Personal Access Token">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <label for="weeks_duration" class="form-label">Number of Weeks</label>
                    <input type="number" name="weeks_duration" id="weeks_duration" class="form-control mb-2" value="4" min="1" max="6" placeholder="Enter number of weeks">
                </div>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="fetchGerrit" name="fetch_gerrit">
              <label class="form-check-label" for="fetchGerrit">
                Fetch Gerrit Data (requires credentials)
              </label>
            </div>
            <div id="gerritCredentials" style="display:none;">
              <div class="row">
                <div class="col-md-6">
                  <label for="gerrit_username" class="form-label">Gerrit Username</label>
                  <input type="text" name="gerrit_username" id="gerrit_username" class="form-control mb-2">
                </div>
                <div class="col-md-6">
                  <label for="gerrit_password" class="form-label">Gerrit Password</label>
                  <input type="password" name="gerrit_password" id="gerrit_password" class="form-control mb-2">
                </div>
              </div>
            </div>
            <div class="alert alert-info" role="alert">
                <small><i class="fas fa-info-circle"></i> <strong>Gerrit Credentials:</strong> If provided, the system will fetch actual Gerrit comments for sentiment analysis. If left empty, Gerrit data will be skipped but Jira data will still be processed.</small>
            </div>
            <button type="submit" class="btn btn-success" id="fetchDataBtn">
                <i class="fas fa-download"></i> Fetch Data from Jira
            </button>
        </form>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
        <div class="card">
            <div class="card-header">
                <h5>Fetching Data from Jira</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <div id="progressText">Initializing...</div>
                <div id="progressDetails" class="mt-2"></div>
            </div>
        </div>
    </div>

    <!-- Error Dialog -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if kpis.total_comments > 0 %}
<div class="row mb-3 data-section" {% if not session.get('jira_file') %}style="display: none;"{% endif %}>
    <div class="col-md-12">
        <div class="alert alert-secondary text-center">
            <strong>Total Entries in CSV:</strong> {{ kpis.total_comments }}
        </div>
    </div>
</div>
{% endif %}
<div class="mb-4 data-section" {% if not session.get('jira_file') %}style="display: none;"{% endif %}>
    <h1 class="fw-bold text-accent mb-3">Team Sentiment Analysis</h1>
    {% if not selected_team %}
    <div class="alert alert-warning text-center mt-3">
        Please select a team from the top right to view the sentiment data.
    </div>
    {% endif %}
    <div class="row mb-2 justify-content-center">
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <a href="/bugs" style="text-decoration:none;">
            <div class="card text-center h-100">
                <div class="card-body p-2" style="background:#1565c0; color:#fff;">
                    <h6 class="card-title mb-1">Bugs</h6>
                    <div class="display-6">{{ total_bugs }}</div>
                </div>
            </div>
            </a>
        </div>
        <div class="col-12 col-md-4 mb-2 mb-md-0">
            <a href="/nonbugs" style="text-decoration:none;">
            <div class="card text-center h-100">
                <div class="card-body p-2" style="background:#1565c0; color:#fff;">
                    <h6 class="card-title mb-1">Non-Bugs</h6>
                    <div class="display-6">{{ total_nonbugs }}</div>
                </div>
            </div>
            </a>
        </div>
        <div class="col-12 col-md-4">
            <a href="/gerrit" style="text-decoration:none;">
            <div class="card text-center h-100">
                <div class="card-body p-2" style="background:#1565c0; color:#fff;">
                    <h6 class="card-title mb-1">Gerrit</h6>
                    <div class="display-6">{{ total_gerrit }}</div>
                </div>
            </div>
            </a>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card text-center h-100">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">Sentiment Distribution (%)</h6>
                    <div class="sentiment-progress my-3" style="display: flex; height: 40px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px #ccc;">
                      <div style="background:#388E3C; color:#fff; width:{{ kpis.positive_pct }}%; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                        {{ kpis.positive_pct }}% Positive
                      </div>
                      <div style="background:#81C784; color:#fff; width:{{ kpis.neutral_pct }}%; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                        {{ kpis.neutral_pct }}% Neutral
                      </div>
                      <div style="background:#F44336; color:#fff; width:{{ kpis.negative_pct }}%; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                        {{ kpis.negative_pct }}% Negative
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4 g-3 data-section" {% if not session.get('jira_file') %}style="display: none;"{% endif %}>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Team Sentiment Distribution</div>
            <div class="card-body d-flex justify-content-center align-items-center" style="min-height:220px;">
                <div style="width:320px; height:240px; margin:auto;">
                  <canvas id="sentimentPie" width="300" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header fw-bold">Team Negative Sentiment Breakdown</div>
            <div class="card-body">
                <div style="overflow-x: auto; width: 100%;">
                  <canvas id="assigneeBar" height="600"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer data-section" {% if not session.get('jira_file') %}style="display: none;"{% endif %}>
    <button class="btn btn-outline-primary me-2" id="download-csv">Download CSV</button>
    <button class="btn btn-outline-success me-2" id="download-xlsx">Download Excel</button>
    <span class="ms-3">Last updated: {{ last_updated }}</span>
  
    <!-- Right-aligned model reference on new line -->
    <div class="text-end mt-2">
      <small>&copy; ThinkPalm / Sentiment Analysis Dashboard<br>
      NLP Model <code>cardiffnlp/twitter-roberta-base-sentiment-latest</code></small>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Store all team sentiment data
const teamSentiment = {{ team_sentiment_dict | tojson }};
const selectedTeam = "{{ selected_team }}";
const overallPie = {{ chart_data.pie | tojson }};
const overallBarLabels = {{ chart_data.bar_labels | tojson }};
const overallBarValues = {{ chart_data.bar_values | tojson }};

// Chart.js Pie
const pieCtx = document.getElementById('sentimentPie').getContext('2d');
let sentimentPie = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: ['Positive', 'Neutral', 'Negative'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#388E3C', '#81C784', '#F44336']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        onClick: function(evt, elements) {
            if (elements && elements.length > 0) {
                var idx = elements[0].index;
                // Only redirect for Positive (0) and Negative (2)
                if (idx === 0 || idx === 2) {
                    window.location.href = '/engineer';
                }
            }
        }
    }
});
// Chart.js Bar
const barCtx = document.getElementById('assigneeBar').getContext('2d');
let assigneeBar = new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'Negative Comments',
            data: [],
            backgroundColor: '#F44336',
            barThickness: 22,
            categoryPercentage: 1.0,
            barPercentage: 0.9
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        onClick: function(evt, elements) {
            if (elements && elements.length > 0) {
                var barIndex = elements[0].index;
                var member = this.data.labels[barIndex];
                if (member) {
                    window.location.href = '/engineer?member=' + encodeURIComponent(member);
                }
            }
        },
        scales: {
            y: {
                ticks: { autoSkip: false }
            }
        }
    }
});

// Hide charts initially
$(document).ready(function() {
    // Show charts for selected team on load
    if (selectedTeam && teamSentiment[selectedTeam]) {
        $('.row.mb-4.g-3').show();
        const teamData = teamSentiment[selectedTeam] || {};
        let pie = [0, 0, 0];
        let barLabels = [];
        let barValues = [];
        if (Object.keys(teamData).length > 0) {
            for (const member in teamData) {
                const memberData = teamData[member];
                pie[0] += memberData["Positive"];
                pie[1] += memberData["Neutral"];
                pie[2] += memberData["Negative"];
                barLabels.push(member);
                barValues.push(memberData["Negative"]);
            }
        }
        sentimentPie.data.datasets[0].data = pie;
        // Sort barLabels and barValues from highest to lowest
        let barData = barLabels.map((label, i) => ({ label, value: barValues[i] }));
        barData.sort((a, b) => b.value - a.value);
        barLabels = barData.map(d => d.label);
        barValues = barData.map(d => d.value);
        assigneeBar.data.labels = barLabels;
        assigneeBar.data.datasets[0].data = barValues;
        // Dynamically set bar chart height
        const barCanvas = document.getElementById('assigneeBar');
        const barCount = barLabels.length;
        const barHeight = 40; // px per bar
        const minHeight = 120;
        const maxHeight = 600;
        const newHeight = Math.min(maxHeight, Math.max(minHeight, barCount * barHeight));
        barCanvas.height = newHeight;
        assigneeBar.resize();
        sentimentPie.update();
        assigneeBar.update();
    } else {
        $('.row.mb-4.g-3').hide();
    }
});

// DataTables
$(document).ready(function() {
    var table = $('#ticketTable').DataTable();
    $('#searchBox').on('keyup', function() {
        table.search(this.value).draw();
    });
});
// Download buttons (CSV/XLSX)
document.getElementById('download-csv').onclick = function() { window.location = '/download/csv'; };
document.getElementById('download-xlsx').onclick = function() { window.location = '/download/xlsx'; };

// Radio button behavior for Manual vs Auto mode
$(document).ready(function() {
    // Check if we should restore auto mode from session storage
    const savedMode = sessionStorage.getItem('selectedMode');
    if (savedMode === 'auto') {
        // Restore auto mode
        $('#autoMode').prop('checked', true);
        $('#manualOptions').hide();
        $('#autoOptions').show();
        $('#progressSection').hide();
        // Clear the saved mode
        sessionStorage.removeItem('selectedMode');
    } else {
        // Show manual options by default
        $('#manualOptions').show();
        $('#autoOptions').hide();
    }
    
    // Handle radio button changes
    $('input[name="dataMode"]').change(function() {
        const selectedMode = $(this).val();
        const previousMode = $(this).data('previous-mode');
        
        // Clear data when switching modes
        if (previousMode && previousMode !== selectedMode) {
            if (confirm('Switching modes will clear existing data. Are you sure?')) {
                clearExistingData();
            } else {
                // Revert the radio button selection
                if (previousMode === 'manual') {
                    $('#manualMode').prop('checked', true);
                } else {
                    $('#autoMode').prop('checked', true);
                }
                return;
            }
        }
        
        // Store current mode for next comparison
        $(this).data('previous-mode', selectedMode);
        
        if (selectedMode === 'manual') {
            $('#manualOptions').show();
            $('#autoOptions').hide();
            $('#progressSection').hide();
        } else if (selectedMode === 'auto') {
            $('#manualOptions').hide();
            $('#autoOptions').show();
            $('#progressSection').hide();
        }
    });
    
    // Handle clear data button
    $('#clearDataBtn').click(function() {
        if (confirm('Are you sure you want to clear all existing data? This action cannot be undone.')) {
            clearExistingData();
        }
    });
    
    // Function to clear existing data
    function clearExistingData() {
        // Show loading state
        $('#clearDataBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Clearing...');
        
        // Make AJAX call to clear data
        $.ajax({
            url: '/clear_data',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    // Update data status to show no data
                    $('#dataStatus').html(`
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i> 
                            <strong>No Data Loaded:</strong> Please upload files or fetch data from Jira to begin analysis.
                        </div>
                    `);
                    
                    // Hide any existing data sections
                    $('.data-section').hide();
                    
                    // Hide clear data button
                    $('#clearDataBtn').hide();
                    
                    // Reset button state
                    $('#clearDataBtn').prop('disabled', false).html('<i class="fas fa-trash"></i> Clear Existing Data');
                    
                    // Show success message
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      '<i class="fas fa-check-circle"></i> Data cleared successfully!' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>').insertAfter('#dataStatus').delay(3000).fadeOut();
                    
                } else {
                    alert('Error clearing data: ' + (response.error || 'Unknown error'));
                    $('#clearDataBtn').prop('disabled', false).html('<i class="fas fa-trash"></i> Clear Existing Data');
                }
            },
            error: function() {
                alert('Error clearing data. Please try again.');
                $('#clearDataBtn').prop('disabled', false).html('<i class="fas fa-trash"></i> Clear Existing Data');
            }
        });
    }
    
    // Handle auto form submission
    $('#auto-form').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Show progress section
        $('#progressSection').show();
        $('#autoOptions').hide();
        
        // Update progress
        updateProgress(0, 'Initializing...');
        
        // Submit form via AJAX
        $.ajax({
            url: '/auto_fetch_data',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = evt.loaded / evt.total * 100;
                        updateProgress(percentComplete, 'Downloading data...');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.success) {
                    updateProgress(100, 'Data fetched successfully!');
                    // Store auto mode in session storage before reload
                    sessionStorage.setItem('selectedMode', 'auto');
                    // Show success message
                    $('#progressText').html('Data fetched successfully! <br><small class="text-success">Redirecting to auto mode...</small>');
                    setTimeout(function() {
                        window.location.reload();
                    }, 2000);
                } else {
                    showError(response.error || 'An error occurred while fetching data.');
                }
            },
            error: function(xhr, status, error) {
                showError('Failed to fetch data: ' + error);
            }
        });
    });
});

$(document).ready(function() {
  $('#fetchGerrit').change(function() {
    if (this.checked) {
      $('#gerritCredentials').show();
      $('#gerrit_username, #gerrit_password').attr('required', true);
    } else {
      $('#gerritCredentials').hide();
      $('#gerrit_username, #gerrit_password').removeAttr('required').val('');
    }
  });
  // Ensure correct state on page load (e.g., after reload)
  if ($('#fetchGerrit').is(':checked')) {
    $('#gerritCredentials').show();
    $('#gerrit_username, #gerrit_password').attr('required', true);
  } else {
    $('#gerritCredentials').hide();
    $('#gerrit_username, #gerrit_password').removeAttr('required').val('');
  }
});

function updateProgress(percent, text) {
    $('#progressBar').css('width', percent + '%');
    $('#progressText').text(text);
}

function showError(message) {
    $('#errorModalBody').text(message);
    $('#errorModal').modal('show');
    $('#progressSection').hide();
    $('#autoOptions').show();
}

// Progress simulation for demo
function simulateProgress() {
    let progress = 0;
    const interval = setInterval(function() {
        progress += 10;
        updateProgress(progress, 'Processing step ' + (progress/10) + '/10...');
        
        if (progress >= 100) {
            clearInterval(interval);
            updateProgress(100, 'Completed!');
        }
    }, 500);
}
</script>
{% endblock %} 